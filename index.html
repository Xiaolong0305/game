<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Last Signal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FFBE00;
            --primary-color-transparent-10: rgba(255, 190, 0, 0.1);
            --primary-color-transparent-30: rgba(255, 190, 0, 0.3);
            --primary-color-transparent-50: rgba(255, 190, 0, 0.5);
            --primary-color-transparent-70: rgba(255, 190, 0, 0.7);
            --primary-color-transparent-80: rgba(255, 190, 0, 0.8);

            --echo-color: #00FFFF;
            --echo-color-transparent-20: rgba(0, 80, 80, 0.2);
            --echo-color-transparent-40: rgba(0, 255, 255, 0.4);

            --bg-color: #111;
            --bg-color-solid: #000;
        }

        /* --- Base & Layout --- */
        body {
            font-family: 'VT323', monospace;
            background-color: var(--bg-color-solid);
            color: var(--primary-color);
            margin: 0;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
            transition: filter 1s ease-in-out;
            overflow: hidden; /* Prevent scrollbars from jumpscare */
        }

        .hidden {
            display: none !important;
        }
        
        main {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .main-menu-container, .game-container {
            position: relative;
            width: 100%;
            max-width: 56rem; /* max-w-4xl */
            padding: 1.5rem; /* p-6 */
            border: 2px solid var(--primary-color-transparent-30);
            background-color: rgba(0, 0, 0, 0.5); /* bg-black/50 */
            box-shadow: 
                0 0 15px var(--primary-color-transparent-30),
                inset 0 0 10px rgba(0,0,0,0.8);
            border-radius: 10px;
        }

        .game-container::before, .main-menu-container::before { /* CRT Bezel Effect */
            content: '';
            position: absolute;
            top: -10px; left: -10px; right: -10px; bottom: -10px;
            border-radius: 20px;
            background: 
                linear-gradient(45deg, #222, #000, #222),
                linear-gradient(135deg, #000, #333, #000);
            z-index: -1;
            box-shadow: 0 0 20px #000;
        }


        h1 {
            font-size: 3rem; /* text-5xl */
            text-align: center;
            margin-bottom: 1rem; /* mb-4 */
            color: var(--primary-color);
            letter-spacing: 0.1em; /* tracking-widest */
            text-shadow: 0 0 8px var(--primary-color-transparent-50);
        }
        
        footer {
            color: var(--primary-color-transparent-50);
            margin-top: 1rem; /* mt-4 */
            font-size: 0.875rem; /* text-sm */
        }

        /* --- Intro Canvas --- */
        .intro-canvas {
            width: 100%;
            height: 20rem; /* h-80 */
            background-color: var(--bg-color-solid);
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            border: 1px solid var(--primary-color-transparent-30);
        }

        .main-menu-container .menu-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 100%;
        }
        .main-menu-container h1 { opacity: 0; pointer-events: none; } /* Hide until animation complete */
        .main-menu-container .menu-button { opacity: 0; pointer-events: none; } /* Hide until animation complete */


        /* --- Screen Effects --- */
        .static-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9998;
            pointer-events: none;
            display: none;
            opacity: 0;
        }
        .static-overlay::before {
            content: "";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWDg4N3d3dtbW17e3t1dXVuZmaEhISfn5+Li4uWlpaRkZF/f39sbGxvb29oGyD+//+dnZ1/f39wcHBgZ2Z0dHT5+fn29vby8vJwcHCKioobJSW6AAAAEHRSTlMAlBCs5kC5/P5x5f5s5Uf3s5PCZgAAAhtJREFUeNq1l9tygyAMhm1d2yTe5/7/Z9s1V0K4GfDwbhtw284920AVi8ViiT3f/d8e3d6fM/Pz8/b29v3m5qa3t7dYW1v5+fnD6urq6Pj4+N/f3/7+frq8vPTz8+Pr6+v7x8fHx8fHx8fHh4eHh4eHh4eHh4ehgaGhoYHR0dERET4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t7e-AAAFB6d3N0AAAAABwgjV8AAAAMAWNIUkABAA2AAAA6AAAA4AAmwB992nPAAAAAg5JREFUeNpiZGZk4DIwYGBgYMDAwMTAzMAEAIxSAAAHAAEA/W6BAAAAABJRU5ErkJggg==');
            z-index: 1;
            animation: static-anim 0.05s infinite steps(1);
        }
        main::after { /* Scanlines */
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 3px, 3px 100%;
            pointer-events: none;
            animation: screen-flicker-anim 8s infinite linear, scanline-scroll 25s linear infinite;
        }
        .vignette-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 12vw rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 10;
        }

        /* --- UI Components --- */
        .story-text, .dread-event-text {
            width: 100%;
            max-width: 56rem;
            padding: 1rem;
            margin: 1rem 0;
            height: 12rem; /* h-48 */
            overflow-y: auto;
            font-size: 1.25rem; /* text-xl */
            line-height: 1.75rem;
            border: 1px solid var(--primary-color-transparent-30);
            background-color: rgba(0,0,0,0.3);
            box-sizing: border-box;
            animation: text-flicker-in-glow 4s linear 1s both;
            text-shadow: 0 0 5px var(--primary-color-transparent-70);
        }

        .dread-event-text {
             height: auto;
             min-height: 2rem;
             color: var(--primary-color-transparent-80);
             border-style: dotted;
             display: none;
        }

        .echo-dialogue {
            width: 100%;
            max-width: 56rem;
            padding: 1rem;
            margin-bottom: 1rem;
            height: 6rem; /* h-24 */
            overflow-y: auto;
            font-size: 1.125rem; /* text-lg */
            border: 1px solid var(--echo-color-transparent-40);
            background-color: var(--echo-color-transparent-20);
            color: var(--echo-color);
            text-shadow: 0 0 5px var(--echo-color), 0 0 10px var(--echo-color);
            box-sizing: border-box;
        }

        .choices-container {
            width: 100%;
            max-width: 56rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* space-y-2 */
        }

        .choice-button, .menu-button {
            padding: 0.75rem;
            font-size: 1.125rem; /* text-lg */
            text-align: left;
            color: var(--primary-color);
            border: 1px solid var(--primary-color-transparent-50);
            background-color: rgba(0,0,0,0.5);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            transform-origin: center;
        }
        .choice-button:hover, .menu-button:hover {
            background-color: var(--primary-color-transparent-10);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.02);
            text-shadow: 0 0 5px var(--primary-color);
        }
        .choice-button:disabled {
            color: var(--primary-color-transparent-50);
            border-color: var(--primary-color-transparent-30);
            cursor: not-allowed;
            transform: none;
        }
        .choice-button .caret, .story-text .caret {
            display: inline-block;
            width: 1ch;
            animation: blinking-caret 1s infinite steps(1);
        }

        .player-stats {
            width: 100%;
            max-width: 56rem;
            font-size: 1.125rem; /* text-lg */
            box-sizing: border-box;
        }
        .player-stats .stats-main {
            padding: 1rem;
            border: 1px solid var(--primary-color-transparent-30);
            background-color: rgba(0,0,0,0.3);
            color: var(--primary-color);
        }
        .player-stats .stats-main span {
            color: var(--primary-color-transparent-70);
        }
        .player-stats .item-button {
            text-decoration: underline dotted;
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            color: inherit;
            font-family: inherit;
            font-size: inherit;
            cursor: pointer;
        }
        .player-stats .item-button:hover {
            color: white;
        }
        .player-stats .item-inspection {
            padding: 1rem;
            margin-top: 0.5rem;
            border: 1px solid var(--primary-color-transparent-30);
            background-color: rgba(0,0,0,0.5);
        }

        /* --- Player Avatar --- */
        .player-avatar-container {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 20;
            border: 2px solid var(--primary-color-transparent-30);
            padding: 0.5rem;
            background: rgba(0,0,0,0.7);
            box-shadow: 0 0 15px var(--primary-color-transparent-30);
            animation: border-flicker 5s infinite;
        }
        .player-avatar-canvas {
            width: 64px;
            height: 96px;
            image-rendering: pixelated;
        }
        
        /* --- Jumpscare --- */
        .jumpscare-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            pointer-events: none;
            display: none;
            image-rendering: pixelated;
        }

        /* --- Animations --- */
        @keyframes scanline-scroll {
            to { background-position: 0 -3px, 0 0; }
        }
        @keyframes screen-flicker-anim {
            0% { opacity: 1; }
            30% { opacity: 0.98; }
            32% { opacity: 0.75; }
            33% { opacity: 1; }
            60% { opacity: 1; }
            62% { opacity: 0.85; }
            64% { opacity: 1; }
            100% { opacity: 1; }
        }
        @keyframes screen-shake { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-2px, 2px); } 50% { transform: translate(2px, -2px); } 75% { transform: translate(2px, 2px); } 100% { transform: translate(-2px, -2px); } }
        @keyframes static-anim { 0% { opacity: 0; } 10% { opacity: 0.1; } 20% { opacity: 0.05; } 30% { opacity: 0.2; } 40% { opacity: 0.1; } 50% { opacity: 0.25; } 60% { opacity: 0.15; } 70% { opacity: 0.3; } 80% { opacity: 0.2; } 90% { opacity: 0.4; } 100% { opacity: 0; } }
        @keyframes show-static { 0% { opacity: 0; } 100% { opacity: 0.2; } }
        @keyframes hide-static { 0% { opacity: 0.2; } 100% { opacity: 0; } }
        @keyframes border-flicker { 0% { border-color: var(--primary-color-transparent-30); } 50% { border-color: var(--primary-color-transparent-80); } 100% { border-color: var(--primary-color-transparent-30); } }
        @keyframes highlight-item { 0% { color: var(--primary-color); text-shadow: none; } 50% { color: #FFFFFF; text-shadow: 0 0 8px #FFFFFF; } 100% { color: var(--primary-color); text-shadow: none; } }
        @keyframes crucial-glow { 0%, 100% { color: #ffbe00; text-shadow: 0 0 3px #ffbe00; } 50% { color: #ffd966; text-shadow: 0 0 8px #ff9900; } }
        @keyframes echo-glitch-anim { 0% { transform: translate(0,0) scale(1); opacity: 1; } 25% { transform: translate(-1px, 1px) scale(1.01); opacity: 0.8; } 50% { transform: translate(1px, -1px) scale(0.99); opacity: 1; } 75% { text-shadow: 0 0 10px #FF00FF; color: #FF00FF; } 100% { transform: translate(0,0) scale(1); opacity: 1; } }
        @keyframes blinking-caret { 50% { opacity: 0; } }
        @keyframes text-fade-in { 0% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes text-flicker-in-glow { 0% { opacity: 0; } 10% { opacity: 0; text-shadow: none; } 10.1% { opacity: 1; text-shadow: none; } 10.2% { opacity: 0; text-shadow: none; } 20% { opacity: 0; text-shadow: none; } 20.1% { opacity: 1; text-shadow: 0 0 30px var(--primary-color-transparent-50); } 20.6% { opacity: 0; text-shadow: none; } 30% { opacity: 0; text-shadow: none; } 30.1% { opacity: 1; text-shadow: 0 0 30px var(--primary-color-transparent-50), 0 0 5px var(--primary-color); } 30.5% { opacity: 1; text-shadow: 0 0 30px var(--primary-color-transparent-50), 0 0 5px var(--primary-color); } 30.6% { opacity: 0; text-shadow: none; } 45% { opacity: 0; text-shadow: none; } 45.1% { opacity: 1; text-shadow: 0 0 30px var(--primary-color-transparent-50), 0 0 5px var(--primary-color); } 50% { opacity: 1; text-shadow: 0 0 30px var(--primary-color-transparent-50), 0 0 5px var(--primary-color); } 55% { opacity: 1; text-shadow: 0 0 30px var(--primary-color-transparent-50), 0 0 5px var(--primary-color); } 55.1% { opacity: 0; text-shadow: none; } 57% { opacity: 0; text-shadow: none; } 57.1% { opacity: 1; text-shadow: 0 0 20px var(--primary-color-transparent-30); } 60% { opacity: 1; text-shadow: 0 0 20px var(--primary-color-transparent-30); } 60.1% { opacity: 0; text-shadow: none; } 65% { opacity: 0; text-shadow: none; } 65.1% { opacity: 1; text-shadow: 0 0 10px var(--primary-color-transparent-30); } 75% { opacity: 1; text-shadow: 0 0 10px var(--primary-color-transparent-30); } 75.1% { opacity: 0; text-shadow: none; } 77% { opacity: 0; text-shadow: none; } 77.1% { opacity: 1; text-shadow: none; } 85% { opacity: 1; text-shadow: none; } 85.1% { opacity: 0; text-shadow: none; } 86% { opacity: 0; text-shadow: none; } 86.1% { opacity: 1; text-shadow: none; } 100% { opacity: 1; } }

        .animate-screen-shake { animation: screen-shake 0.3s infinite steps(1); }
        .item-added-highlight { animation: highlight-item 1.5s ease-out; }
        .crucial-item-highlight { animation: crucial-glow 2s infinite ease-in-out; }
        .echo-glitch { animation: echo-glitch-anim 0.2s infinite steps(1); }
    </style>
</head>
<body>
    <main>
        <div class="vignette-overlay"></div>
        <div id="main-menu-container">
            <canvas id="intro-canvas" class="intro-canvas" width="600" height="300"></canvas>
            <div class="menu-content">
                <h1>The Last Signal</h1>
                <div class="choices-container">
                    <button id="start-button" class="menu-button">
                        <span class="caret">> </span>Begin Transmission
                    </button>
                </div>
            </div>
        </div>

        <div id="game-container" class="game-container hidden">
            <h1>The Last Signal</h1>
            <div class="player-avatar-container">
                <canvas id="player-avatar-canvas" class="player-avatar-canvas" width="64" height="96"></canvas>
            </div>
            <div id="story-text" class="story-text"></div>
            <div id="player-stats" class="player-stats"></div>
            <div id="game-choices-container" class="choices-container"></div>
        </div>
        <footer>A Psychological Horror Experience</footer>
    </main>
    
    <canvas id="jumpscare-canvas" class="jumpscare-canvas"></canvas>
    <div class="static-overlay"></div>

    <div id="audio-elements" style="display: none;">
        <audio id="main-menu-theme" loop preload="auto" src="https://cdn.pixabay.com/audio/2022/08/04/audio_32b04334b0.mp3"></audio>
        <audio id="distress-signal-sound" preload="auto" src="https://cdn.pixabay.com/audio/2022/11/17/audio_8b42f61536.mp3"></audio>
        <audio id="ambient-sound" loop preload="auto" src="https://cdn.pixabay.com/audio/2022/10/24/audio_34b0f27568.mp3"></audio>
        <audio id="sanity-loss-sound" preload="auto" src="https://cdn.pixabay.com/audio/2022/02/17/audio_c3702e5b38.mp3"></audio>
        <audio id="event-sound" preload="auto" src="https://cdn.pixabay.com/audio/2022/09/20/audio_255a29a149.mp3"></audio>
        <audio id="click-sound" preload="auto" src="https://cdn.pixabay.com/audio/2022/03/24/audio_3226ef3f80.mp3"></audio>
        <audio id="item-pickup-sound" preload="auto" src="https://cdn.pixabay.com/audio/2022/03/07/audio_1e372a6d71.mp3"></audio>
        <audio id="discovery-sound" preload="auto" src="https://cdn.pixabay.com/audio/2022/11/17/audio_8b42f61536.mp3"></audio>
        <audio id="creak-sound" preload="auto" src="https://cdn.pixabay.com/audio/2023/08/03/audio_a0a55543c8.mp3"></audio>
        <audio id="unlock-sound" preload="auto"src="https://cdn.pixabay.com/audio/2022/03/08/audio_1526b38c22.mp3"></audio>
        <audio id="generator-start" preload="auto" src="https://cdn.pixabay.com/audio/2022/01/24/audio_82c6d2c4b1.mp3"></audio>
        <audio id="wave-crash" preload="auto" src="https://cdn.pixabay.com/audio/2023/11/04/audio_c97034c514.mp3"></audio>
        <audio id="jumpscare-sound" preload="auto" src="https://cdn.pixabay.com/audio/2023/07/26/audio_2631535447.mp3"></audio>
        <audio id="echo-sound" preload="auto" src="https://cdn.pixabay.com/audio/2022/03/23/audio_9857d4a64e.mp3"></audio>
        <audio id="static-crackle-sound" preload="auto" src="https://cdn.pixabay.com/audio/2022/02/21/audio_a7e0892913.mp3"></audio>
    </div>

<script>
// Using an IIFE to encapsulate the entire game script
(function() {
    'use strict';

    // --- DATA --- //
    const items = {
        'Weak Radio': { name: 'Weak Radio', description: 'My standard-issue radio. Good for short-range, but not powerful enough to cut through a blizzard like this for long.' },
        'Crowbar': { name: 'Crowbar', description: 'A heavy piece of rusted steel. Good for prying things open. The weight is strangely comforting.', isCrucial: true },
        'Painkillers': { name: 'Painkillers', description: 'A small bottle of generic painkillers. These might help quiet the ringing in my ears and steady my nerves.' },
        'Old Diary': { name: 'Old Diary', description: "A leather-bound journal, warped by damp. The pages are filled with a frantic, looping script. He scribbled numbers in the margin: 4 8 15 16. A frequency? A code? It feels... wrong to hold it.", isCrucial: true },
        'Signal Booster': { name: 'Signal Booster', description: 'A piece of experimental, high-gain radio equipment. If I could hook it up to a powerful enough antenna, I could reach the mainland.', isCrucial: true },
        'Generator Key': { name: 'Generator Key', description: 'A small, brass key, stamped with "ENGINEERING". It feels cold to the touch.' },
        'Fuse': { name: 'Fuse', description: 'A thick, ceramic-cased industrial fuse. Looks like it could handle a serious electrical load.' },
        'Keeper\'s Note': { name: 'Keeper\'s Note', description: 'A hastily scrawled note. It reads: "It hates the radio. The frequency... it holds it back. Don\'t let it go silent."' },
        'Keeper\'s Keys': { name: 'Keeper\'s Keys', description: 'A ring of old, ornate keys. One is labeled "Master", another "Bedroom".' },
        'Safe Dial': { name: 'Safe Dial', description: 'A heavy, brass dial for a combination safe. It seems to have been pried off something.' },
        'Welding Torch': { name: 'Welding Torch', description: 'A portable torch with a small fuel canister. Highly flammable. Could cut through a lock if I had to.' },
    };

    const gameData = {
        start: {
            getText: ({ lastInspection }) => {
                const baseText = "The blizzard howls, a lonely counterpoint to the hiss of my radio. It's been a quiet tour at this remote arctic outpost. Too quiet. My shift is almost over when a burst of static rips through the speaker. I lean in, turning the dial. A voice, faint and desperate, cuts through the noise.\n'...in the light... It's in the light... Don't let it out... Echo Rock...repeating...'";
                if (lastInspection === 'radio') {
                    return baseText + "\n\n[INSPECTION] My radio is a sturdy, old thing. Military surplus. The dials are worn smooth. It's my only connection to the outside world, and right now, it feels like a lifeline being frayed by that impossible signal from Echo Rock. The frequency for the distress call is anomalously low, almost subterranean.";
                }
                return baseText;
            },
            choices: () => [
                { text: "Examine my radio equipment.", action: 'inspect', payload: 'radio' },
                { text: "It's just static. Turn off the radio.", destinationId: 'endingIgnored'},
                { text: "It's a ghost signal. Going out in this blizzard is suicide.", destinationId: 'endingTrapped' },
                { text: "Echo Rock? That lighthouse has been a tomb for 50 years. I have to know.", destinationId: 'journeyToLighthouse', onEnterSound: 'distress-signal-sound' },
            ],
        },
        journeyToLighthouse: {
            getText: () => "I pull on my heaviest gear, the cold already biting before I'm even out the door. The journey is a nightmare. The wind is a physical assault, a screaming wall of white. Every shadow looks like a waiting figure, every gust of wind sounds like a whisper. My compass spins uselessly. I navigate by instinct alone, a growing knot of dread in my stomach my only guide.",
            choices: () => [
                { text: "Press on. The signal is my only bearing.", destinationId: 'approachLighthouse', action: 'updateSanity', payload: -5 },
                { text: "Use my weak radio to call for help now.", destinationId: 'endingDistress' },
                { text: "This is madness. Try to find my way back to the outpost.", destinationId: 'endingFrozen' },
            ],
        },
        approachLighthouse: {
            getText: () => "It feels like hours before the skeletal frame of Echo Rock Lighthouse looms out of the whiteout. It's a tombstone against the grey sky, dark and silent. A deep, primal dread settles in my gut. This place feels wrong.",
            choices: () => [
                { text: "This is a mistake. Turn back before I freeze.", destinationId: 'endingHypothermia' },
                { text: "The main entrance looks sealed. I'll check it anyway.", destinationId: 'lighthouseEntrance'},
                { text: "Circle the base. There must be another way in.", destinationId: 'lighthouseBase'},
            ],
        },
        lighthouseEntrance: {
            getText: () => "The heavy iron door is pitted with rust that looks like dried blood. A complex lock is set into it, long seized by time. As I get close, I hear a rhythmic *scratch... scratch...* from the other side. It stops the moment I touch the cold metal. My blood runs cold.",
            choices: () => [{ text: "It's sealed tight. I'll circle the base.", destinationId: 'lighthouseBase'}],
        },
        lighthouseBase: {
            getText: () => "The wind screams past the curved walls. My flashlight beam cuts through the swirling snow, landing on a rusted maintenance hatch near the foundation. It's barely clinging to its hinges. Nearby, a small, weathered toolbox is half-buried in a snowdrift. I feel like I'm not alone out here.",
            choices: ({ playerInventory }) => [
                ...(!playerInventory.some(i => i.name === 'Crowbar') ? [{ text: "Try to pry the hatch open with my bare hands.", destinationId: 'hatchFail', action: 'updateSanity', payload: -5 }] : []),
                { text: "Use the crowbar on the hatch.", destinationId: 'hatchSuccess', requiredItem: 'Crowbar' },
                ...(!playerInventory.some(i => i.name === 'Crowbar') ? [{ text: "Dig out that toolbox.", destinationId: 'toolbox' }] : []),
                { text: "Go back to the main entrance. Maybe I missed something.", destinationId: 'lighthouseEntrance' },
            ],
        },
        toolbox: {
            getText: () => "I kick the snow away and wrench the toolbox open. The hinges scream. Inside, among useless rusted tools, is a solid crowbar. It feels heavy, a comforting weight against the oppressive emptiness.",
            choices: () => [{ text: "Take the crowbar. Time to open that hatch.", destinationId: 'lighthouseBase', action: 'addItem', payload: 'Crowbar' }],
        },
        hatchFail: {
            getText: () => "I pull and pull, my fingers screaming in the cold. It won't budge. A sharp edge slices my glove and the skin beneath. The sudden pain is a shock, and a wave of pure despair washes over me. What am I doing here?",
            choices: () => [{ text: "This is hopeless. Circle the base again.", destinationId: 'lighthouseBase' }],
        },
        hatchSuccess: {
            getText: ({ playerSanity }) => {
                if (playerSanity > 60) return "The crowbar gives me the leverage I need. A groan of tortured metal echoes, and the hatch gives way, opening into absolute darkness. A smell of salt, damp, and something else... something sweet and rotten, wafts out, making me gag.";
                return "I jam the crowbar into the seam and heave. The shriek of metal is deafening. The hatch flies open, revealing a gaping black maw. The stench that pours out is indescribable, a cloying mix of decay and ozone. For a second, I swear I saw two pale points of light staring back at me from the abyss before they vanished.";
            },
            choices: () => [{ text: "There's no turning back. Descend.", destinationId: 'storageRoom' }],
            onEnterSound: 'creak-sound',
        },
        storageRoom: {
            getText: ({ playerSanity, echoState }) => {
                if (playerSanity > 70) return "I drop into a cramped storage room. The air is thick with dust. Shelves line the walls. My flashlight picks out a small bottle of painkillers and an old leather-bound diary. A sturdy metal door leads deeper into the lighthouse foundation.";
                if (playerSanity > 40) return "The darkness swallows me. This room feels wrong, claustrophobic. The shadows writhe at the edge of my light. I spot a bottle of pills that promise relief, and a diary that feels cold to the touch. A heavy door looms in the gloom, an unspoken challenge.";
                return "Blackness. I'm in a tight, wrong room. Walls are too close, shadows crawl. My light shakes. Pills on a shelf, want them. Diary, feels like ice, don't want to touch it. Door. Looming. Get out. Get out.";
            },
            choices: ({ playerInventory, playerSanity }) => {
                const choices = [];
                if (!playerInventory.some(i => i.name === 'Painkillers')) choices.push({ text: "Take the painkillers.", action: 'addItem', payload: 'Painkillers' });
                if (playerInventory.some(i => i.name === 'Painkillers')) choices.push({ text: "Use the painkillers.", action: 'multi', payload: [{type: 'removeItem', payload: 'Painkillers'}, {type: 'updateSanity', payload: 15}] });
                if (!playerInventory.some(i => i.name === 'Old Diary')) choices.push({ text: "Take the old diary.", action: 'multi', payload: [{type: 'addItem', payload: 'Old Diary'}, {type: 'updateSanity', payload: -5}, {type: 'jumpscare', payload: 'diary'}] });
                choices.push({ text: "Go through the door to the engine room.", destinationId: 'engineRoom', action: 'updateSanity', payload: -5 });
                return choices;
            },
        },
        engineRoom: {
            getText: ({ isPowerOn, lastInspection }) => {
                let baseText;
                if (isPowerOn) {
                    baseText = "The generator hums with a steady, reassuring rhythm, bathing the room in clean, bright light. The oppressive gloom has receded, but the cold remains. An electronic mag-lock on the main door has disengaged with a soft click. The path to the main floor is clear.";
                } else {
                    baseText = "The engine room is a metal cavern dominated by a massive, silent diesel generator. It's freezing. The air smells of old oil and rust. A fuse box hangs open on one wall, a key component clearly missing. A heavy door with a mag-lock leads to the main floor, currently unpowered and sealed. Another door is marked 'Fuel Storage'.";
                }

                if (lastInspection === 'generator') {
                    if (isPowerOn) {
                        return baseText + "\n\n[INSPECTION] I run my hand over the humming casing. It's a massive diesel beast, surprisingly clean. The vibrations are a comfort. A plaque reads 'Model V-12 'Leviathan''. Appropriate.";
                    } else {
                        return baseText + "\n\n[INSPECTION] It's a cold, silent monolith of steel. Thick cables snake from it into the walls, covered in a film of grime. It feels like a sleeping giant, and I'm not sure I want to wake it.";
                    }
                }
                return baseText;
            },
            choices: ({ playerInventory, isPowerOn }) => {
                if (isPowerOn) {
                    return [
                        { text: "Inspect the humming generator.", action: 'inspect', payload: 'generator' },
                        { text: "Head up to the now-unlocked main floor.", destinationId: 'mainFloor', onEnterSound: 'unlock-sound' }
                    ];
                }
                const choices = [
                    { text: "Inspect the silent generator.", action: 'inspect', payload: 'generator' },
                    { text: "The door to the main floor is sealed by an unpowered mag-lock.", disabled: true },
                    { text: "Try the door to the Fuel Storage room.", destinationId: 'fuelStorage' },
                    { text: "Go back to the storage room.", destinationId: 'storageRoom' },
                ];
                if (playerInventory.some(i => i.name === 'Fuse')) {
                    choices.unshift({ text: "Install the Fuse and start the generator.", destinationId: 'engineRoom', action: 'multi', payload: [{type: 'removeItem', payload: 'Fuse'}, {type: 'setPower', payload: true}], onEnterSound: 'generator-start' });
                }
                return choices;
            },
        },
        fuelStorage: {
            getText: ({ playerSanity }) => {
                if (playerSanity > 60) return "The room is filled with the acrid smell of diesel. Several large fuel drums line the walls. On top of one, a heavy-duty fuse sits next to a pile of oily rags.";
                return "A wave of dizziness hits me as I enter. The fumes are thick, and the shadows in the corners seem to drip from the ceiling. Something sits on a barrel across the room. A fuse. But... the air around it shimmers, like heat haze on a frozen day.";
            },
            choices: ({ playerInventory }) => {
                const choices = [{ text: "This smell is making me sick. Back to the engine room.", destinationId: 'engineRoom' }];
                if (!playerInventory.some(i => i.name === 'Fuse')) {
                    choices.unshift({ text: "Grab the fuse.", action: 'addItem', payload: 'Fuse' });
                }
                return choices;
            }
        },
        mainFloor: {
            getText: () => "Emergency lights cast long, dancing shadows. This was the keeper's living quarters. An overturned table, a cold fireplace, and a door marked 'Keeper's Bedroom'. A spiral staircase leads up into the darkness.",
            choices: () => [
                { text: "The bedroom door is locked.", disabled: true },
                { text: "Climb the spiral staircase.", destinationId: 'upperLevels', action: 'updateSanity', payload: -10 },
                { text: "Go back to the engine room.", destinationId: 'engineRoom' },
            ]
        },
        upperLevels: {
            getText: ({ playerSanity }) => {
                if(playerSanity > 60) return "The spiral staircase is narrow and slick with moisture. Each metal step groans under my weight. The sound of the storm is much louder here. There are two landings above: one for a small radio room, and the final one at the very top for the lantern itself.";
                return "The stairs feel... unstable. They sway slightly with each step, or maybe that's just me. The howling wind sounds like a thousand screaming voices. I see doors ahead, one for the radio room, one for the lantern. They seem to stretch and warp in the dim light.";
            },
            choices: (gameState) => [
                { text: "Proceed to the Radio Room.", destinationId: 'radioRoom' },
                { text: "Climb all the way to the Lantern Room.", destinationId: 'lanternRoom' },
                { text: "My nerves are shot. Go back down.", destinationId: 'mainFloor' },
                { text: "Lean over the railing to see below.", destinationId: 'endingFell', condition: (gs) => gs.playerSanity < 30 },
            ],
        },
        radioRoom: {
            getText: () => "This must have been the primary communications hub. Wires hang like vines from the ceiling, and smashed equipment litters the floor. A safe sits in the corner, its door slightly ajar. On a desk, a single sheet of paper is held down by a heavy brass dial.",
            choices: (gs) => {
                const choices = [ { text: "Leave the radio room.", destinationId: 'upperLevels' } ];
                if (!gs.playerInventory.some(i => i.name === 'Safe Dial')) choices.unshift({ text: "Take the brass dial.", action: 'addItem', payload: 'Safe Dial' });
                if (!gs.playerInventory.some(i => i.name === 'Signal Booster')) choices.unshift({ text: "Check the safe.", destinationId: 'safeOpen' });
                return choices;
            }
        },
        safeOpen: {
            getText: () => "The safe is empty, except for a complex piece of equipment - the Signal Booster. This is it. This is how I call for help.",
            choices: () => [
                { text: "Take the Signal Booster and leave.", destinationId: 'radioRoom', action: 'addItem', payload: 'Signal Booster' }
            ],
            onEnterSound: 'unlock-sound'
        },
        lanternRoom: {
            getText: ({ playerSanity }) => {
                if (playerSanity > 50) return "I'm in the lantern room. The heart of the lighthouse. The massive lens is dark and inert. Below it, the complex rotation machinery is exposed. A control panel is nearby, its primary amplification slot empty. The wind and waves crash against the glass just feet away. It's exhilarating and terrifying.";
                return "I emerge into the lantern room and the world outside is a churning vortex of snow and sea. The glass groans under the assault of the storm. The giant lens is a dead, glassy eye staring into the chaos. The control panel looks... wrong. The labels are in a language I don't recognize, shifting and reforming before my very eyes.";
            },
            choices: ({ playerInventory }) => {
                const choices = [{ text: "Go back down the stairs.", destinationId: 'upperLevels' }];

                if (playerInventory.some(i => i.name === 'Signal Booster')) {
                    choices.unshift({ text: "Install the Signal Booster into the control panel.", destinationId: 'endingEscape', action: 'jumpscare', payload: 'entity' });
                } else {
                    choices.unshift({ text: "The control panel is missing a high-gain signal booster.", disabled: true });
                }
                if (playerInventory.some(i => i.name === 'Crowbar')) {
                    choices.push({ text: "Smash the lens. Release whatever is inside.", destinationId: 'endingLiberation', action: 'updateSanity', payload: -30 });
                }
                choices.push({ text: "Look out at the storm.", destinationId: 'cyclicalChoice', action: 'incrementCyclicalCounter' });
                return choices;
            }
        },
        cyclicalChoice: {
            getText: ({ cyclicalCounter }) => {
                if (cyclicalCounter >= 3) return "The storm outside is... beautiful. The swirling snow, the crashing waves, the screaming wind... it's a symphony. And I'm the conductor. I've always been the conductor. I remember now. The signal isn't a distress call. It's an invitation. My invitation.";
                return "I stare into the heart of the storm. The waves are black mountains, the snow a physical wall. For a moment, I see a face in the clouds, vast and ancient, its expression one of immense sorrow. My head spins, and I stumble back, the vision gone as quickly as it came.";
            },
            choices: ({ cyclicalCounter }) => {
                if (cyclicalCounter >= 3) return [{ text: "It's time to begin again.", destinationId: 'endingCyclical' }];
                return [{ text: "Step back from the glass. My head hurts.", destinationId: 'lanternRoom' }];
            }
        },
        // --- Endings ---
        endingIgnored: { isEnding: true, getText: () => "Just static. You switch the radio off, plunging the room into comfortable silence. You finish your shift, file a report about faulty equipment, and go home. You sleep soundly, never knowing the signal that went unanswered." },
        endingDistress: { isEnding: true, getText: () => "You fumble with your radio, the wind tearing at your hands. You scream for help, but the blizzard just screams back. A sudden, blinding spark erupts from the radio as snow gets inside. It's dead. You are alone, lost in the white, with no signal to guide you." },
        endingTrapped: { isEnding: true, getText: () => "You decide it's not worth the risk. You barricade the door and huddle by your radio, listening to the storm. The distress signal from Echo Rock fades, replaced by the howling wind. Days turn into weeks. Your supplies run low. The silence becomes your tomb. You are never found." },
        endingFrozen: { isEnding: true, getText: () => "The cold seeps into your bones. This was a foolish, deadly errand. You turn back, but the snow is relentless. You lose your way in the whiteout, your final thoughts a frozen regret. The storm claims another soul." },
        endingHypothermia: { isEnding: true, getText: () => "You flee the lighthouse, the dread propelling you back into the storm. But the cold is a patient hunter. Your strength fades, and you collapse into a snowdrift, the dark shape of the lighthouse the last thing you see." },
        endingFell: { isEnding: true, getText: () => "You lean over the railing, dizzy and disoriented. The spiral staircase seems to twist into an infinite abyss. Your foot slips. The fall is short, but the stop is sudden. Darkness." },
        endingMadness: { isEnding: true, getText: () => "The whispers become a roar. The shadows coalesce into jagged, impossible shapes that dance just for you. The lighthouse is no longer a prison; it's a cathedral, and you are its new god. You climb to the top of the lantern, fling open the glass, and greet the storm with a loving, ecstatic scream. Your signal joins the chorus." },
        endingEscape: { isEnding: true, onEnterSound: 'discovery-sound', getText: ({playerSanity}) => {
            if(playerSanity < 40) return "The signal booster slides into place. The lamp flares to life. You send your distress call. Hours later, a rescue helicopter arrives. You're saved, but you can't stop screaming about the thing you saw in the light, a great, dark shape blotting out the stars. They sedate you for the journey home. You spend the rest of your days in a quiet, padded room, watching the shadows."
            return "The signal booster slides into place. You divert the generator's power, and with a deafening hum, the ancient lamp flares to life, ten times brighter than it ever was. Its beam cuts through the blizzard like a surgeon's scalpel. You send out your own distress call, your voice clear and strong. Hours later, through the dissipating storm, you see the glorious light of a rescue helicopter. You're saved. But as you look back at the lighthouse, you can't shake the feeling that something is now free.";
        }},
        endingCyclical: { isEnding: true, getText: () => "And the loop closes. You are not an operator; you are the signal. You are the ghost in the machine, the echo in the rock. Your purpose is to draw another soul to this place, to perpetuate the story. As your consciousness fades, you feel a new one arriving at the edge of the storm, drawn by a faint distress call...\n'...in the light... It's in the light... Don't let it out... Echo Rock...repeating...'" },
        endingLiberation: { isEnding: true, getText: () => "With a scream of defiance, you swing the crowbar again and again. The massive lens cracks, then shatters. A wave of non-sound, a pressure that deafens you, explodes outwards. The light inside is not a beam, but a being of pure, impossible geometry. It unfolds itself into the sky. The storm stops. Everything stops. You have just ended the world." },
    };
    
    // --- PIXEL ART & CANVAS LOGIC --- //
    const pixelArtData = {
        colors: {
            bg: '#0c0c10', wall: '#343840', floor: '#252830', desk: '#4a2e1a',
            radioBody: '#222', radioGlow: 'rgba(255, 190, 0, 0.9)',
            playerJacket: '#6b4d3b', playerPants: '#3d4a5e', playerSkin: '#c29d84', playerHair: '#1a110a',
            glitch1: '#ff00ff', glitch2: '#00ffff', white: '#ffffff', black: '#000000',
            blood: '#880808', entity: '#1a001a'
        },
        introScene: {
            width: 40, height: 20,
            map: [ "WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW", "W....................................W", "W....................................W", "W....................................W", "W....................................W", "W....................................W", "W...............R....................W", "W..............RRR...................W", "W..............RGR...................W", "W..............RRR...................W", "W.............DDDDD..................W", "W.............DDDDD..................W", "W............P.......................W", "W....................................W", "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF", "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF", "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF", "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF", "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF", "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF", ],
        },
        playerSprites: {
            calm: [
                ["    HHHH    ", "   HSSSSH   ", "   HSSSSH   ", "    HSSH    ", "  JJJJJJJJ  ", " J  J  J  J ", " J  J  J  J ", "J   JJJJ   J", "J   J  J   J", "    PPPP    ", "    P  P    ", "    P  P    "],
                ["    HHHH    ", "   HSSSSH   ", "   HSSSSH   ", "    HSSH    ", "  JJJJJJJJ  ", " J  J  J  J ", " J  J  J  J ", "J   JJJJ   J", "J   J  J   J", "    PPPP    ", "    P  P    ", "   P    P   "]
            ],
            nervous: [
                ["            ", "    HHHH    ", "   HSSSSH   ", "   HSSSSH   ", "  JJSHSJ    ", " JJJSJJJSJJ ", "JJJ J  J JJJ", "J   JJJJ   J", "    PPPP    ", "    P  P    ", "    P  P    ", "            "],
                ["            ", "    HHHH    ", "   HSSSSH   ", "   HSSSSH   ", "  JJS S J   ", " JJJSJJJSJJ ", "JJJ J  J JJJ", "J   JJJJ   J", "    PPPP    ", "    P  P    ", "   P    P   ", "            "]
            ],
        },
        jumpscares: {
            diary: [["   HHHHHH   ", "  H      H  ", " H        H ", " H BBBBBBH ", " H BWBWB H ", " H BBBBBBH ", "  H      H  ", "   HHHHHH   "]],
            mirror: [
                ["   HHHHHHHH   ", "  HBBBBBBBBH  ", " HBW B B WBH  ", " HBBBBBBBBH  ", " HBB BBBBH  ", " HBBBBBBBH  ", "  H BBBBH  ", "   HHHHHH   "],
                ["   11111111   ", "  1222222221  ", " 12W 2 2 W21  ", " 1222222221  ", " 122 22221  ", " 122222221  ", "  1 22221  ", "   111111   "],
                ["   HHHHHHHH   ", "  HBBBBBBBBH  ", " HBW B B WBH  ", " HBBBBBBBBH  ", "  H      H  ", "  H M  M H  ", "  H  MM  H  ", "   HHHHHH   "],
            ],
            keeper: [
                ["      ....      ", "    ..1111..    ", "   .11222211.   ", "  .121.22.121.  ", "  .122222221.  ", "  .12.2222.21.  ", "   .11111111.   ", "    ..1111..    ", "      ....      "],
                ["                ", "    ..2222..    ", "   .22111122.   ", "  .212.11.212.  ", "  .2111111112.  ", "  .21.1111.12.  ", "   .22222222.   ", "    ..2222..    ", "                "],
            ],
            entity: [
                [
                    "........................................", 
                    "..........EE..................EE..........", 
                    "........EEEE................EEEE........", 
                    "......E..EE..E............E..EE..E......", 
                    "....EEEEEEEEEEEE........EEEEEEEEEEEE....", 
                    "....E.E.E.E.E.E..........E.E.E.E.E.E....", 
                    "....EEEEEEEEEEEE........EEEEEEEEEEEE....", 
                    "......E..EE..E............E..EE..E......", 
                    "........EEEE................EEEE........", 
                    "..........EE..................EE..........", 
                    "........................................", 
                    "........................................", 
                    "..........EE..................EE..........", 
                    "........EEEE................EEEE........", 
                    "......E..EE..E............E..EE..E......", 
                    "....EEEEEEEEEEEE........EEEEEEEEEEEE....", 
                    "....E.E.E.E.E.E..........E.E.E.E.E.E....", 
                    "....EEEEEEEEEEEE........EEEEEEEEEEEE....", 
                    "......E..EE..E............E..EE..E......", 
                    "........EEEE................EEEE........", 
                    "..........EE..................EE..........", 
                    "........................................"
                ]
            ]
        }
    };

    // --- DOM ELEMENT REFERENCES (Declared here, assigned after DOM loads) --- //
    let doc, body, mainMenuContainer, gameContainer, startButton, storyTextEl, 
        choicesContainer, playerStatsEl, staticOverlay, introCanvas, 
        playerAvatarCanvas, jumpscareCanvas;

    // Game state
    let gameState = {};
    let typewriterInterval;
    let avatarAnimationId;

    // --- HELPER & CORE LOGIC FUNCTIONS (Must be defined before use) --- //
    // Using `let` for render functions to allow for forward declaration,
    // as they may be called by actions defined before them.
    let renderScene, renderPlayerStats;

    const playSound = (id, volume = 1) => {
        const sound = doc.getElementById(id);
        if (sound instanceof HTMLAudioElement) {
            sound.currentTime = 0;
            sound.volume = volume;
            sound.play().catch(e => console.warn(`Audio playback failed for ${id}:`, e));
        }
    };

    const fadeAudio = (id, from, to, duration) => {
        const sound = doc.getElementById(id);
        if (!(sound instanceof HTMLAudioElement)) return;
        
        let currentVolume = from;
        sound.volume = currentVolume;
        if (from === 0 && sound.paused) {
            sound.play().catch(e => {});
        }
        const step = (to - from) / (duration / 50);

        const fade = setInterval(() => {
            currentVolume += step;
            if ((step > 0 && currentVolume >= to) || (step < 0 && currentVolume <= to)) {
                currentVolume = to;
                clearInterval(fade);
                if (to === 0) sound.pause();
            }
            sound.volume = Math.max(0, Math.min(1, currentVolume));
        }, 50);
    };

    const drawPixelArt = (ctx, map, pixelSize, colorMap) => {
        map.forEach((row, y) => {
            row.split('').forEach((char, x) => {
                if (colorMap[char]) {
                    ctx.fillStyle = colorMap[char];
                    ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
                }
            });
        });
    };

    const triggerStatic = (duration) => {
        if (!staticOverlay) return;
        staticOverlay.style.display = 'block';
        staticOverlay.style.animation = `show-static 0.1s forwards`;
        playSound('static-crackle-sound', 0.4);

        setTimeout(() => {
            staticOverlay.style.animation = `hide-static 0.2s forwards`;
            setTimeout(() => staticOverlay.style.display = 'none', 200);
        }, duration);
    };

    // --- STATE MODIFIERS (pure state changes, no rendering) --- //
    const stateModifiers = {
        updateSanity: (amount) => {
            const oldSanity = gameState.playerSanity;
            const newSanity = Math.max(0, Math.min(100, oldSanity + amount));
            gameState.playerSanity = newSanity;
            if (amount < 0 && oldSanity > newSanity) {
                playSound('sanity-loss-sound', 0.7);
                triggerStatic(200);
            }
        },
        addItem: (itemName) => {
            if (!gameState.playerInventory.some(i => i.name === itemName)) {
                playSound('item-pickup-sound');
                gameState.playerInventory.push(items[itemName]);
            }
        },
        removeItem: (itemName) => {
            gameState.playerInventory = gameState.playerInventory.filter(i => i.name !== itemName);
        },
        setPower: (state) => {
            gameState.isPowerOn = state;
        },
        incrementCyclicalCounter: () => {
            gameState.cyclicalCounter++;
        },
        multi: (payload) => {
            payload.forEach(action => {
                if (stateModifiers[action.type]) {
                    stateModifiers[action.type](action.payload);
                } else if (actions[action.type]) { // Actions also need to be callable here.
                    actions[action.type](action.payload);
                }
            });
        },
    };

    // --- GAME ACTIONS (effects, potential UI updates) --- //
    // **CRITICAL FIX**: These are defined AFTER the render functions are declared
    // but before they are assigned. They call the `renderScene` variable which will
    // hold the correct function when the action is eventually triggered by a click.
    const actions = {
        jumpscare: (type) => {
            playSound('jumpscare-sound');
            triggerStatic(300);
            body.classList.add('animate-screen-shake');
            setTimeout(() => body.classList.remove('animate-screen-shake'), 300);
            renderJumpscare(type);
        },
        inspect: (topic) => {
            gameState.lastInspection = topic;
            renderScene();
        },
        inspectItem: (itemName) => {
            gameState.inspectedItem = gameState.inspectedItem === itemName ? null : itemName;
            renderPlayerStats();
        },
    };

    // --- RENDERING LOGIC --- //
    const typewriterEffect = (element, text) => {
        clearInterval(typewriterInterval);
        let i = 0;
        const speed = 30;
        element.innerHTML = ''; // Clear content

        typewriterInterval = setInterval(() => {
            if (i <= text.length) {
                let currentText = text.substring(0, i);
                const sanity = gameState.playerSanity;

                if (sanity < 50) {
                    let glitchedText = '';
                    for (let j = 0; j < currentText.length; j++) {
                        let char = currentText.charAt(j);
                        // Small chance to glitch any character in the visible string
                        if (char.trim() !== '' && Math.random() < (50 - sanity) / 50 * 0.02) {
                            const glitchChars = '!@#$%^&*()_+}{[]|\\:;"<>,.?/~`';
                            char = glitchChars[Math.floor(Math.random() * glitchChars.length)];
                        }
                        glitchedText += char;
                    }
                    currentText = glitchedText;
                }
                
                element.innerHTML = `${currentText}<span class="caret">_</span>`;
                i++;
                element.scrollTop = element.scrollHeight;
            } else {
                clearInterval(typewriterInterval);
                // When finished, show the clean, correct text.
                element.innerHTML = text;
            }
        }, speed);
    };
    
    // Assign function to the previously declared `let` variable.
    renderPlayerStats = () => {
        if (!playerStatsEl) return;
        playerStatsEl.innerHTML = '';
        
        const mainStats = doc.createElement('div');
        mainStats.className = 'stats-main';
        
        let inventoryHTML = '';
        gameState.playerInventory.forEach((item, index) => {
            inventoryHTML += `${index > 0 ? ', ' : ''}<button class="item-button ${item.isCrucial ? 'crucial-item-highlight' : ''}" data-item="${item.name}">${gameState.inspectedItem === item.name ? `[ ${item.name} ]` : item.name}</button>`;
        });
        
        mainStats.innerHTML = `SANITY: ${gameState.playerSanity}% | <span>INVENTORY:</span> ${inventoryHTML}`;
        playerStatsEl.appendChild(mainStats);
        
        if (gameState.inspectedItem) {
            const inspectionDiv = doc.createElement('div');
            inspectionDiv.className = 'item-inspection';
            inspectionDiv.textContent = items[gameState.inspectedItem].description;
            playerStatsEl.appendChild(inspectionDiv);
        }

        playerStatsEl.querySelectorAll('.item-button').forEach(button => {
            button.addEventListener('click', () => actions.inspectItem(button.dataset.item));
        });
    };
    
    // A single, reliable function to handle processing a player's choice.
    const processChoice = (choice) => {
        playSound(choice.onEnterSound || 'click-sound');

        // Actions are special cases that may render differently or not change scenes.
        // They handle their own rendering and stop the normal flow.
        if (choice.action && actions[choice.action] && !stateModifiers[choice.action]) {
            actions[choice.action](choice.payload);
            return;
        }

        // Apply any state modifiers associated with the choice.
        if (choice.action && stateModifiers[choice.action]) {
            stateModifiers[choice.action](choice.payload);
        }
        
        // After state changes, check for sanity-loss ending.
        if (gameState.playerSanity <= 0) {
            gameState.currentSceneId = 'endingMadness';
        } else if (choice.destinationId) {
            // Otherwise, move to the next scene.
            gameState.currentSceneId = choice.destinationId;
            gameState.lastInspection = null;
        }

        // Render the final, updated state.
        renderScene();
    };
    
    // Assign function to the previously declared `let` variable.
    renderScene = () => {
        if (!storyTextEl || !choicesContainer || !playerStatsEl) {
             console.error("Render failed: A critical DOM element was not found.");
             return;
        }
        const scene = gameData[gameState.currentSceneId];
        if (!scene) return;

        // Update body class for low sanity effects
        body.style.filter = gameState.playerSanity < 70 ? `blur(${(70 - gameState.playerSanity) * 0.05}px) saturate(${100 - (70 - gameState.playerSanity) * 1.5}%)` : 'none';
        body.classList.toggle('animate-screen-shake', gameState.playerSanity < 40);
        
        // Render story text
        typewriterEffect(storyTextEl, scene.getText(gameState));
        renderPlayerStats();
        
        // Render choices
        choicesContainer.innerHTML = '';
        if (scene.isEnding) {
            const button = doc.createElement('button');
            button.className = 'choice-button';
            button.innerHTML = `<span class="caret">> </span>The signal fades. [RESTART]`;
            button.onclick = restartGame;
            choicesContainer.appendChild(button);
        } else {
            const choices = scene.choices(gameState);
            choices.forEach(choice => {
                if ((choice.requiredItem && !gameState.playerInventory.some(i => i.name === choice.requiredItem)) || (choice.condition && !choice.condition(gameState))) {
                    return;
                }
                
                const button = doc.createElement('button');
                button.className = 'choice-button';
                button.innerHTML = `<span class="caret">> </span>${choice.text}`;
                button.disabled = !!choice.disabled;
                button.onclick = () => processChoice(choice);
                choicesContainer.appendChild(button);
            });
        }
    };
    
    const renderPlayerAvatar = () => {
        cancelAnimationFrame(avatarAnimationId);
        const ctx = playerAvatarCanvas.getContext('2d');
        let frame = 0;
        const pixelSize = 4;
        
        const colorMap = {
            'H': pixelArtData.colors.playerHair, 'S': pixelArtData.colors.playerSkin,
            'J': pixelArtData.colors.playerJacket, 'P': pixelArtData.colors.playerPants,
            ' ': 'transparent'
        };

        const draw = () => {
            const sanity = gameState.playerSanity;
            if (playerAvatarCanvas) {
                ctx.clearRect(0, 0, playerAvatarCanvas.width, playerAvatarCanvas.height);
                let spriteSheet = sanity > 70 ? pixelArtData.playerSprites.calm : pixelArtData.playerSprites.nervous;
                const frameIndex = Math.floor(frame / 30) % spriteSheet.length;
                const currentSprite = spriteSheet[frameIndex];
                
                const yOffset = 4, xOffset = 2;

                currentSprite.forEach((row, y) => {
                    row.split('').forEach((char, x) => {
                        if (colorMap[char]) {
                            if (sanity < 40 && Math.random() < (40 - sanity) / 40 * 0.5) {
                                ctx.fillStyle = `rgba(${Math.random()*255}, ${Math.random()*255}, ${Math.random()*255}, 0.8)`;
                                ctx.fillRect((x + xOffset + Math.random()*2-1) * pixelSize, (y + yOffset + Math.random()*2-1) * pixelSize, pixelSize, pixelSize);
                            } else {
                                ctx.fillStyle = colorMap[char];
                                ctx.fillRect((x + xOffset) * pixelSize, (y + yOffset) * pixelSize, pixelSize, pixelSize);
                            }
                        }
                    });
                });
            }
            frame++;
            avatarAnimationId = requestAnimationFrame(draw);
        };
        draw();
    };

    const renderJumpscare = (type) => {
        const scareData = pixelArtData.jumpscares[type];
        if (!scareData) return;
        
        jumpscareCanvas.style.display = 'block';
        const ctx = jumpscareCanvas.getContext('2d');
        let frame = 0;
        
        const colorMap = {
            'H': pixelArtData.colors.playerHair, 'S': pixelArtData.colors.playerSkin,
            'B': pixelArtData.colors.black, 'W': pixelArtData.colors.white, 'M': pixelArtData.colors.blood,
            '1': pixelArtData.colors.glitch1, '2': pixelArtData.colors.glitch2,
            'E': pixelArtData.colors.entity, '.': 'transparent'
        };

        const draw = () => {
            const scareFrame = scareData[frame % scareData.length];
            const pixelSize = Math.min(
                Math.floor(window.innerWidth / scareFrame[0].length),
                Math.floor(window.innerHeight / scareFrame.length)
            );
            jumpscareCanvas.width = window.innerWidth;
            jumpscareCanvas.height = window.innerHeight;
            ctx.fillStyle = pixelArtData.colors.black;
            ctx.fillRect(0, 0, jumpscareCanvas.width, jumpscareCanvas.height);

            const startX = (jumpscareCanvas.width - (scareFrame[0].length * pixelSize)) / 2;
            const startY = (jumpscareCanvas.height - (scareFrame.length * pixelSize)) / 2;
            
            ctx.save();
            ctx.translate(startX, startY);
            drawPixelArt(ctx, scareFrame, pixelSize, colorMap);
            ctx.restore();
            frame++;
        };
        
        draw();
        const interval = setInterval(draw, 100);

        setTimeout(() => {
            clearInterval(interval);
            jumpscareCanvas.style.display = 'none';
        }, 800);
    };

    const renderIntro = (onFinished) => {
        const ctx = introCanvas.getContext('2d');
        const pixelSize = Math.floor(introCanvas.height / pixelArtData.introScene.height);
        introCanvas.width = pixelSize * pixelArtData.introScene.width;
        
        const colorMap = {
            'W': pixelArtData.colors.wall, 'F': pixelArtData.colors.floor,
            'D': pixelArtData.colors.desk, 'R': pixelArtData.colors.radioBody,
            '.': pixelArtData.colors.bg, 'G': pixelArtData.colors.radioGlow,
            'P': pixelArtData.colors.playerJacket,
        };

        let frame = 0;
        const distressCall = "'...It's in the light... Don't let it out... Echo Rock...repeating...'";
        let textProgress = 0;
        let animationFrameId;

        const wrapText = (context, text, maxWidth) => {
            const words = text.split(' ');
            let lines = [];
            let currentLine = words[0] || '';
            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = context.measureText(currentLine + " " + word).width;
                if (width < maxWidth) currentLine += " " + word;
                else { lines.push(currentLine); currentLine = word; }
            }
            lines.push(currentLine);
            return lines;
        }

        const draw = () => {
            ctx.clearRect(0, 0, introCanvas.width, introCanvas.height);
            drawPixelArt(ctx, pixelArtData.introScene.map, pixelSize, colorMap);

            if (frame > 60 && Math.floor(frame / 15) % 2 === 0) {
                ctx.fillStyle = pixelArtData.colors.radioGlow;
                ctx.fillRect(15 * pixelSize, 8 * pixelSize, pixelSize, pixelSize);
            }

            if (frame > 100) {
                ctx.fillStyle = 'rgba(0,0,0,0.8)';
                ctx.fillRect(5 * pixelSize, 12 * pixelSize, 30 * pixelSize, 6 * pixelSize);
                ctx.strokeStyle = 'var(--primary-color)';
                ctx.strokeRect(5 * pixelSize, 12 * pixelSize, 30 * pixelSize, 6 * pixelSize);

                ctx.fillStyle = 'white';
                ctx.font = `${pixelSize * 1.5}px VT323`;
                ctx.textAlign = 'left';
                const lines = wrapText(ctx, distressCall.substring(0, textProgress), 28 * pixelSize);
                lines.forEach((line, i) => {
                    ctx.fillText(line, 6 * pixelSize, (14 + i * 1.5) * pixelSize);
                });
            }
            frame++;
            animationFrameId = requestAnimationFrame(draw);
        }

        const startText = () => {
            playSound('distress-signal-sound', 0.6);
            const textInterval = setInterval(() => {
                textProgress++;
                if (textProgress > distressCall.length) {
                    clearInterval(textInterval);
                    setTimeout(() => onFinished(), 1000);
                }
            }, 50);
        }

        setTimeout(startText, 2000);
        draw();
    };


    // --- GAME INITIALIZATION --- //
    const getInitialGameState = () => ({
        currentSceneId: 'start',
        playerSanity: 100,
        playerInventory: [items['Weak Radio']],
        isPowerOn: false,
        cyclicalCounter: 0,
        lastInspection: null,
        inspectedItem: null,
    });
    
    const startGame = () => {
        gameState = getInitialGameState();
        mainMenuContainer.classList.add('hidden');
        gameContainer.classList.remove('hidden');

        fadeAudio('main-menu-theme', 0.5, 0, 1000);
        const ambient = doc.getElementById('ambient-sound');
        if (ambient instanceof HTMLAudioElement) {
            ambient.volume = 0;
            ambient.currentTime = 0;
            ambient.play().catch(e => {});
            fadeAudio('ambient-sound', 0, 0.3, 2000);
        }

        renderScene();
        renderPlayerAvatar();
    };

    const restartGame = () => {
        mainMenuContainer.classList.remove('hidden');
        gameContainer.classList.add('hidden');
        fadeAudio('main-menu-theme', 0, 0.5, 2000);
    };

    // --- MAIN EXECUTION --- //
    document.addEventListener('DOMContentLoaded', () => {
        // Assign DOM element references now that the DOM is fully loaded
        doc = document;
        body = doc.body;
        mainMenuContainer = doc.getElementById('main-menu-container');
        gameContainer = doc.getElementById('game-container');
        startButton = doc.getElementById('start-button');
        storyTextEl = doc.getElementById('story-text');
        choicesContainer = doc.getElementById('game-choices-container');
        playerStatsEl = doc.getElementById('player-stats');
        staticOverlay = doc.querySelector('.static-overlay');
        introCanvas = doc.getElementById('intro-canvas');
        playerAvatarCanvas = doc.getElementById('player-avatar-canvas');
        jumpscareCanvas = doc.getElementById('jumpscare-canvas');


        const showMenuContent = () => {
            const titleEl = mainMenuContainer.querySelector('h1');
            const buttonEl = doc.getElementById('start-button');
            if (titleEl && buttonEl) {
                titleEl.style.opacity = '1';
                titleEl.style.pointerEvents = 'auto';
                titleEl.style.animation = 'text-fade-in 1s both';
                
                setTimeout(() => {
                    buttonEl.style.opacity = '1';
                    buttonEl.style.pointerEvents = 'auto';
                    buttonEl.style.animation = 'text-flicker-in-glow 2s linear both';
                }, 1000);
            }
        };

        renderIntro(showMenuContent);
        
        const theme = doc.getElementById('main-menu-theme');
        if (theme instanceof HTMLAudioElement && theme.paused) {
            theme.volume = 0;
            theme.play().catch(e => {});
            fadeAudio('main-menu-theme', 0, 0.5, 2000);
        }
        
        startButton.addEventListener('click', startGame);
    });

})();
</script>
</body>
</html>